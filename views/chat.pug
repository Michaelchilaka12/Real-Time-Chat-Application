//- views/chat.pug
doctype html
html
  head
    meta(charset='utf-8')
    meta(name='viewport' content='width=device-width,initial-scale=1')
    title Real-Time Chat
    //- link(rel='stylesheet', href='/css/chat.css')

    // Internal CSS
    style.
      html, body { height: 100%; margin: 0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
        .chat-container { display: flex; flex-direction: column; height: 100vh; }
        .chat-header { height: 64px; background: #3f51b5; color: #fff; display:flex; align-items:center; padding: 0 16px; box-sizing:border-box; }
        .chat-header .me { display:flex; align-items:center; gap:10px; }
        .chat-header img { border-radius:50%; }

        nav.chat-tabs { display:flex; gap:8px; padding:10px 16px; background:#f5f5f5; border-bottom:1px solid #e9e9e9; box-sizing:border-box; }
        nav.chat-tabs button { padding:10px 24px; border-radius:4px; border: none; background: transparent; cursor:pointer; font-weight:600; }
        nav.chat-tabs button.active { background:#fff; box-shadow: 0 2px 0 #3f51b5 inset; }

        /* main split */
        .chat-main { flex:1; display:flex; min-height:0; } /* min-height:0 is important so children can overflow */
        .users-list, .groups-list { width: 300px; flex: 0 0 300px; padding:16px; border-right: 1px solid #eee; box-sizing: border-box; overflow:auto; background:#fff; }
        .users-list h3, .groups-list h3 { margin-top:0; }

        main.chat-box { flex:1; display:flex; flex-direction:column; min-width:0; /* important for flex overflow */ }
        .chat-history { flex:1 1 auto; overflow-y:auto; padding:16px; box-sizing:border-box; background:#fafafa; padding-bottom:120px; /* ensure last message not hidden by input */ }

        /* messages */
        .message-row { display:flex; gap:8px; margin-bottom:10px; align-items:flex-end; max-width:85%; }
        .message-row.me { margin-left:auto; justify-content:flex-end; }
        .message-row .msg-bubble { padding:10px 14px; border-radius:14px; display:inline-block; max-width:100%; word-wrap:break-word; }
        .message-row.me .msg-bubble { background:#3f51b5; color:#fff; border-bottom-right-radius:4px; }
        .message-row.other .msg-bubble { background:#fff; border:1px solid #e6e6e6; color:#111; }

        /* input / footer */
        .chat-input { display:flex; gap:8px; align-items:center; padding:12px; box-sizing:border-box; border-top:1px solid #e6e6e6; background:#fff; position: sticky; bottom: 0; z-index: 5; }
        .chat-input input[type="text"], .chat-input input[type="search"] {
          flex:1; min-width:0; padding:10px 12px; border-radius:8px; border:1px solid #ddd;
        }
        .chat-input button { padding:10px 16px; border-radius:8px; border:none; background:#3f51b5; color:white; cursor:pointer; }

        /* avatar */
        .avatar-small { width:34px; height:34px; border-radius:50%; object-fit:cover; }

        /* status dot */
        .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-left:8px; vertical-align:middle; }
        .status-dot.online { background: #2ecc71; }
        .status-dot.offline { background: #e74c3c; }

        /* responsive */
        @media (max-width: 800px) {
          .users-list, .groups-list { width:100%; flex: none; border-right:none; border-bottom:1px solid #eee; }
          .chat-main { flex-direction: column; }
          .chat-history { padding-bottom: 140px; }
        }

      /* Beautiful button links */
      .btn-link {
        display: inline-block;
        padding: 10px 18px;
        margin: 6px 0;
        font-size: 15px;
        font-weight: 600;
        text-decoration: none;
        color: white;
        background: linear-gradient(135deg, #4a90e2, #007aff);
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        text-align: center;
      }

      .btn-link:hover {
        background: linear-gradient(135deg, #007aff, #0056b3);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.25);
      }

      /* Responsive styles */
      @media (max-width: 768px) {
        .chat-section {
          flex-direction: column;
        }

        .users-list, .groups-list {
          flex: none;
          width: 100%;
          border-right: none;
          border-bottom: 1px solid #ddd;
        }

        .chat-box {
          flex: 1;
          display: flex;
          flex-direction: column;
          height: calc(100vh - 200px); /* adjust based on your header height */
        }

        .messages {
          max-height: calc(100vh - 260px); /* keep it scrollable */
        }
      }
      @media (max-width: 480px) {
        .chat-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }
        .chat-tabs button {
          font-size: 13px;
          padding: 10px;
        }
        .btn-link {
          width: 100%;
        }
      }
      img{
        margin-Top:10px;
      }
      /* Floating message options menu */
      .msg-options {
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: absolute;
        background: #ffffff;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        min-width: 140px;
        animation: fadeIn 0.2s ease-in-out;
      }

      .msg-options button {
        background: none;
        border: none;
        outline: none;
        padding: 8px 10px;
        text-align: left;
        font-size: 14px;
        cursor: pointer;
        border-radius: 6px;
        transition: background 0.2s ease;
      }

      .msg-options button:hover {
        background: #f0f0f0;
      }

      .msg-options button:active {
        background: #e0e0e0;
      }
      .msg-bubble {
        position: relative;
        z-index: 10;
        cursor: pointer;
        -webkit-user-select: none; /* disable weird highlighting on long press */
        user-select: none;
      }
      .msg-bubble {
        -webkit-touch-callout: none; /* disable iOS callout */
        -webkit-user-select: none;
        user-select: none;
      }


      .msg-options {
        z-index: 9999 !important; /* menu always on top */
      }
      @media (max-width: 600px) {
        .msg-bubble {
          pointer-events: none;
        }
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }
   



  body
    .chat-container
      header.chat-header
        if user
          .me
            img.user-photo(src=user.profilePic || '/images/default-avatar.png' alt=user.name width='40' height='40')
            span.user-name= user.name
        else
          span.user-name Not signed in

      nav.chat-tabs
        button#private-tab.active(type='button') Private Chats
        button#group-tab(type='button') Group Chats

      //- PRIVATE CHAT
      section#private-chat.chat-section
        aside.users-list
          a.btn-link(href='/profilePic') Upload Profile Picture
          a.btn-link(href='/update') Update your details  
          h3 Contacts
          ul#contacts
        main.chat-box
          .chat-history#private-history
          div#private-typing(style="color: gray; font-size: 14px; margin: 5px 0;")
          .chat-input
            input#private-message(type='text' placeholder='Type a message...')
            button#send-private(type='button' disabled) Send

      //- GROUP CHAT
      section#group-chat.chat-section.hidden
        aside.groups-list
          h3 Groups
          button#create-group-btn(type='button') + Create Group
          h4 My Groups
          ul#my-groups
          h4 All Groups
          ul#all-groups
        main.chat-box
          .chat-history#group-history
          div#group-typing(style="color: gray; font-size: 14px; margin: 5px 0;")
          .chat-input
            input#group-message(type='text' placeholder='Type a message...')
            button#send-group(type='button' disabled) Send

    script.
      const CURRENT_USER = !{JSON.stringify(user || {})};
    script(src='/socket.io/socket.io.js')
    script(src='/js/chat.js')
